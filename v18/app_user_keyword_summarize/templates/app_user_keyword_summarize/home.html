{% extends 'base.html' %} {% block title %}
é—œéµè©é—œè¯å’ŒAIåˆ†æ
{% endblock title %} {% block content %}
        <div class="col-lg-12">
          <h1>é—œéµè©é—œè¯å’ŒAIåˆ†æ</h1>
          <p>
            å°ä½ æƒ³è¦äº†è§£çš„è­°é¡Œé€²è¡Œå…¨æ–‡æª¢ç´¢ï¼Œä¸¦é€éAIå¹«å¿™åˆ†æ
          </p>
        </div>

        <div class="col-lg-6 mb-2">
          <!-- è¼¸å…¥æ¢ä»¶å€å¡Šé–‹å§‹ -->
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">è¼¸å…¥æ¢ä»¶</h3>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <label class="col-md-3 col-form-label">é—œå¿ƒå“ªå€‹é—œéµè©?</label>
                <div class="col-md-9">
                  <input
                    id="input_keyword"
                    name="userkey"
                    value="å·æ™®"
                    class="form-control"
                  />
                  <div class="form-text">
                    å…¨æ–‡æœå°‹ï¼Œå¯è¼¸å…¥å¤šå€‹é—œéµè©æˆ–ç‰‡æ®µè©å¥ï¼Œä»¥ç©ºç™½éš”é–‹ã€‚
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <label class="col-sm-3 col-form-label">æ¢ä»¶</label>

                <div class="col-md-9">
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="and"
                      name="condradio"
                      id="condradio1"
                    />
                    <label class="form-check-label" for="condradio1">and</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="or"
                      name="condradio"
                      id="condradio2"
                      checked
                    />
                    <label class="form-check-label" for="condradio2">or</label>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <label class="col-sm-3 col-form-label">æ–°èé¡åˆ¥</label>
                <div class="col-md-9">
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="å…¨éƒ¨"
                      name="cateradio"
                      id="cateradio1"
                      checked
                    />
                    <label class="form-check-label" for="cateradio1">å…¨éƒ¨</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="åœ‹éš›"
                      name="cateradio"
                      id="cateradio2"
                    />
                    <label class="form-check-label" for="cateradio2">åœ‹éš›</label>     
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="æ”¿æ²»"
                      name="cateradio"
                      id="cateradio3"
                    />
                    <label class="form-check-label" for="cateradio3">æ”¿æ²»</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="ç¤¾æœƒåœ°æ–¹"
                      name="cateradio"
                      id="cateradio4"
                    />
                    <label class="form-check-label" for="cateradio4">ç¤¾æœƒåœ°æ–¹</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="è²¡ç¶“"
                      name="cateradio"
                      id="cateradio5"
                    />
                    <label class="form-check-label" for="cateradio5">è²¡ç¶“</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="é‹å‹•"
                      name="cateradio"
                      id="cateradio6"
                    />
                    <label class="form-check-label" for="cateradio6">é‹å‹•</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="å¥åº·"
                      name="cateradio"
                      id="cateradio7"
                    />
                    <label class="form-check-label" for="cateradio7">å¥åº·</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="éŠæˆ²3C"
                      name="cateradio"
                      id="cateradio8"
                    />
                    <label class="form-check-label" for="cateradio8">éŠæˆ²3C</label>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label class="col-md-3 col-form-label">æœ€è¿‘å¤šå°‘å‘¨?</label>
                <div class="col-md-9">
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="1"
                      name="wkradio"
                      id="wkradio1"
                    />
                    <label class="form-check-label" for="wkradio1">1</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="2"
                      name="wkradio"
                      id="wkradio2"
                      checked
                    />
                    <label class="form-check-label" for="wkradio2">2</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="3"
                      name="wkradio"
                      id="wkradio3"
                    />
                    <label class="form-check-label" for="wkradio3">3</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="4"
                      name="wkradio"
                      id="wkradio4"
                    />
                    <label class="form-check-label" for="wkradio4">4</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="6"
                      name="wkradio"
                      id="wkradio6"
                    />
                    <label class="form-check-label" for="wkradio6">6</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="8"
                      name="wkradio"
                      id="wkradio8"
                    />
                    <label class="form-check-label" for="wkradio8">8</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="12"
                      name="wkradio"
                      id="wkradio12"
                    />
                    <label class="form-check-label" for="wkradio12">12</label>
                  </div>
                  <div class="form-text">
                    ä»¥æœ€æ–°è³‡æ–™æ™‚é–“ç‚ºæº–ï¼Œå¾€å‰æ¨å¤šå°‘å‘¨?
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <label class="col-sm-3 col-form-label">åˆ†ææ¨¡å¼</label>
                <div class="col-md-9">
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="æ‘˜è¦"
                      name="mode"
                      id="mode1"
                      checked
                    />
                    <label class="form-check-label" for="mode1">ç¸½é«”æ‘˜è¦</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="é—œéµå•ç­”"
                      name="mode"
                      id="mode2"
                    />
                    <label class="form-check-label" for="mode2">å€‹åˆ¥æ–°èé—œéµå•ç­”</label>     
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      value="åˆ†æå‹å ±å°"
                      name="mode"
                      id="mode3"
                    />
                    <label class="form-check-label" for="mode3">å€‹åˆ¥æ–°èåˆ†æå‹å ±å°</label>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-9 ms-auto">
                  <button type="button" id="btn_ok" class="btn btn-primary">
                    æŸ¥è©¢
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- è¼¸å…¥å€å¡ŠçµæŸ-->

        <!-- ç¹ªåœ–å€å¡Š-->
        <div class="col-lg-6 mb-2">
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">é€™äº›è©èˆ‡å®ƒåŒæ™‚å‡ºç¾å–”!</h3>
            </div>
            <div class="card-body">
              <div id="cloud"></div>
            </div>
          </div>
        </div>
        <!-- å€å¡ŠçµæŸ-->

        <!-- é¡¯ç¤ºå€å¡Šé–‹å§‹ -->
        <div class="col-lg-12 mb-3">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="mb-0">AIæ–°èåˆ†æ</h4>
            </div>
            <div class="card-body markdown-body">
              <div id="chat_container" class="overflow-auto" style="height: 60vh; max-height: 500px;"></div>
            </div>
          </div>
        </div>

        <!-- æ–°èé€£çµå€å¡Š-->
        <div class="col-lg-6 mb-2">
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">ä»¥ä¸‹æ–°èèˆ‡å®ƒæœ‰é—œ(å–æ•¸ç¯‡å±•ç¤º)</h3>
            </div>
            <div class="card-body">
              <h2 id="num_articles"></h2>
              <ul class="list-group" id="newslinks"></ul>
            </div>
          </div>
        </div>
        <!-- å€å¡ŠçµæŸ-->

        <!-- åŒæ™‚å‡ºç¾çš„é—œéµå­—å€å¡Š-->
        <div class="col-lg-6 mb-2">
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">èˆ‡å®ƒåŒæ™‚å‡ºç¾çš„é—œéµå­—</h3>
            </div>
            <div class="card-body">
              <ul id="related_words"></ul>
            </div>
          </div>
        </div>
        <!-- å€å¡ŠçµæŸ-->
        {% endblock content %} 
  
{% block extra_css %}
  <!-- GitHub Markdown CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css" />
{% endblock %}
{% block extra_js %}
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- chartjs-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
  <script src="https://cdn.rawgit.com/jasondavies/d3-cloud/v1.2.1/build/d3.layout.cloud.js"></script>

  <!-- Here are your codes -->
  <script>
    // Show the page with default setting when page is initialized.
    call_ajax();

    // btn submit
    $("#btn_ok").on("click", function () {
      call_llm_report_generation_ajax();
    }); //event function

    // category radio button
    $("input[name='cateradio']").on("change", function () {
      call_ajax();
    }); //event function

    // weeks radio button
    $("input[name='wkradio']").on("change", function () {
      call_ajax();
    }); //event function

    // condition radio button
    $("input[name='condradio']").on("change", function () {
      call_ajax();
    }); //event function

    function call_ajax() {
      const userkey = $("#input_keyword").val();
      const weeks = $("input[name='wkradio']:checked").val();
      const cate = $("input[name='cateradio']:checked").val();
      const cond = $("input[name='condradio']:checked").val();

      if (userkey.length < 2) {
        alert("è¼¸å…¥é—œéµå­—ä¸å¯ç©ºç™½æˆ–å°æ–¼å…©å€‹ä¸­æ–‡å­—!");
        return 0;
      }
      $.ajax({
        type: "POST",
        url: "api_get_userkey_summarize/",
        data: {
          userkey: userkey,
          cate: cate,
          weeks: weeks,
          cond: cond,
        }, // pass to server
        success: function (received) {
          console.log("ğŸ§¾ received:", received);
          //è‹¥æŸ¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºæé†’è¨Šæ¯
          if (received['error']) {
            alert('æª¢ç´¢ç•°å¸¸å›æ‡‰: ' + received['error'])
            return 0
          } 
          // display number of articles or stories
          const num_articles = received["num_articles"];
          $("#num_articles").empty();
          $("#num_articles").append(`<h2 style="color:red">ç¸½ç¯‡æ•¸:${num_articles}</h2>`);
          
          // show news title and link
          const newslinks = received["newslinks"];
          $("#newslinks").empty();
          if (newslinks.length == 0) {
            alert("No result returned!");
          }
          // show news title and link
          for (let i = 0; i < newslinks.length; i++) {
            const items =`
              <li class="list-group-item py-2 border-bottom">
                  <div class="d-flex align-items-center">
                      <span class="badge bg-secondary me-2 px-2 py-1">${newslinks[i].category}</span>
                      <a href="${newslinks[i].link}" class="text-decoration-none" target="_blank">${newslinks[i].title}</a>
                  </div>
              </li>`;
            $("#newslinks").append(items);
          }

          // show related words
          const related_words = received["related_words"];
          $("#related_words").empty();
          for (let i = 0; i < related_words.length; i++) {
            $("#related_words").append(   `<li>${related_words[i]}</li>`  );
          }

          // draw word cloud for related words
          topWordToDraw = received.clouddata;
          $("#cloud").empty();
          drawCloud(topWordToDraw, "#cloud");
        }, //success function

        error: function (msg, status) {
          console.log(msg);
          console.log(status);
        }, //print status and msg when ajax goes wrong
      }); //ajax
    } //function call_ajax()

    function call_llm_report_generation_ajax() {
      console.log("AJAX called");
      const userkey = $('#input_keyword').val()
      const weeks = $("input[name='wkradio']:checked").val()
      const cate = $("input[name='cateradio']:checked").val()
      const cond = $("input[name='condradio']:checked").val()
      const mode = $("input[name='mode']:checked").val()
    
      if (userkey.length < 2) {
        alert('è¼¸å…¥é—œéµå­—ä¸å¯ç©ºç™½æˆ–å°æ–¼å…©å€‹ä¸­æ–‡å­—!')
        return 0
      }
    
      // æ¸…ç©ºèŠå¤©å®¹å™¨
      $('#chat_container').empty()
    
      // æ·»åŠ "æ­£åœ¨è¼¸å…¥"æŒ‡ç¤ºç¬¦
      let typingIndicator = addTypingIndicator()
    
      $.ajax({
        type: 'POST',
        url: 'api_get_userkey_report/',
        data: {
          userkey: userkey,
          cate: cate,
          weeks: weeks,
          cond: cond,
          mode: mode,
        }, // pass to server
        success: function (received) {
          // ç§»é™¤"æ­£åœ¨è¼¸å…¥"æŒ‡ç¤ºç¬¦
          typingIndicator.remove()
    
          //è‹¥æŸ¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºæé†’è¨Šæ¯
          if (received['error']) {
            alert('æª¢ç´¢ç•°å¸¸å›æ‡‰: ' + received['error'])
            return 0
          }
    
          // é¡¯ç¤ºAIå ±å‘Š
          if (received['report']) {
            report = received['report']
            report = marked.parse(report)
            displayReport(report)
          }
        } //function
      }) //ajax
    } //call_ajax()
    
    // æ·»åŠ "æ­£åœ¨è¼¸å…¥"æŒ‡ç¤ºç¬¦
    function addTypingIndicator() {
      const indicatorHTML = `
                <div class="typing-indicator d-flex justify-content-start mb-3">
                  <div class="card bg-light" style="max-width: 75%;">
                    <div class="card-body py-2 px-3">
                      <div class="d-flex align-items-center">
                        <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                        <span>AI æ­£åœ¨æ€è€ƒï¼Œè«‹è€å¿ƒç­‰å€™...</span>
                      </div>
                    </div>
                  </div>
                </div>
              `
    
      $('#chat_container').append(indicatorHTML)
      scrollToBottom()
    
      return $('.typing-indicator')
    }

    function displayReport(report) {
      // ä½¿ç”¨ marked.js å°‡ markdown è½‰ç‚º HTML
      const renderedHTML = marked.parse(report)
      const reportHTML = `
            <div class="d-flex justify-content-start mb-3">
              <div class="card bg-light" style="max-width: 90%;">
                <div class="card-body py-2 px-3">
                  <div class="report-content">${renderedHTML}</div>
                </div>
              </div>
            </div>
          `
      $('#chat_container').append(reportHTML)
      scrollToBottom()
    }

    // æ»¾å‹•åˆ°åº•éƒ¨
    function scrollToBottom() {
      const chatContainer = document.getElementById('chat_container')
      chatContainer.scrollTop = chatContainer.scrollHeight
    }
    
    function drawCloud(topWordToDraw, element_id) {
      // You should set a proper box size to show cloud chart
      const width = 500;
      const height = 500;

      // First define your cloud data, using `text` and `size` properties:
      // Next you need to use the layout script to calculate the placement, rotation and size of each word:
      // Constructs a new cloud layout instance.
      // Wordcloud features that are different from one word to the other
      d3.layout
        .cloud()
        .size([width, height])
        .words(topWordToDraw) //data for cloud chart
        .rotate(function () {
          //return ~~(Math.random() * 2) * 90; //~~1.5 => 1  (same as Math.floor(1.5))
          return 0; // don't rotate
        })
        .font("Impact")
        .fontSize(function (d) {
          return d.size;
        })
        .on("end", draw) //call function draw()
        .start();

      // Finally implement `draw`, which performs the D3 drawing
      // This function takes the output of 'layout' above and draw the words
      // Wordcloud features that are THE SAME from one word to the other can be here
      function draw(words) {
        const fill = d3.scale.category20();

        // append the svg object to the body of the page
        d3.select(element_id)
          .append("svg") // element_id such as "#cloud"
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr(
            "transform",
            "translate(" + ~~(width / 2) + "," + ~~(height / 2) + ")"
          )
          .selectAll("text")
          .data(words)
          .enter()
          .append("text")
          .style("font-size", function (d) {
            return d.size + "px";
          })
          .style("-webkit-touch-callout", "none")
          .style("-webkit-user-select", "none")
          .style("-khtml-user-select", "none")
          .style("-moz-user-select", "none")
          .style("-ms-user-select", "none")
          .style("user-select", "none")
          .style("cursor", "default")
          .style("font-family", "Impact")
          .style("fill", function (d, i) {
            return fill(i);
          })
          .attr("text-anchor", "middle")
          .attr("transform", function (d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function (d) {
            return d.text;
          });
      } //draw
    } //drawCloud()

  </script>
{% endblock extra_js %}
